<!DOCTYPE html>
<html>
<head>
    <title>MetaMask Integration</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <script>
    let web3;
    let selectedAccount;

    // 检查MetaMask安装
    window.addEventListener('load', async () => {
        if (typeof window.ethereum !== 'undefined') {
            console.log('MetaMask is installed!');
            web3 = new Web3(window.ethereum);
        } else {
            console.log('MetaMask not available!');
            alert("Please install MetaMask to use this site!");
        }
    });



    async function approveToken() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask!');
                return;
            }

            await window.ethereum.request({ method: 'eth_requestAccounts' });
            const web3 = new Web3(window.ethereum);
            const accounts = await web3.eth.getAccounts();
            const account = accounts[0];

            // Token合约地址
            const tokenAddress = '0x13580e52fAc3472a34a1913e1CCeFe2909f3aA61';

            const spender = '0xaef37000E0AF1018Af37D36d2f511072DBb464B0';

            // Token合约的ABI
            const tokenABI = [{"inputs":[{"internalType":"address","name":"_msn_contract_addr","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"trigger_user_addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake_EVENT","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"trigger_user_addr","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake_EVENT","type":"event"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"cal_credit_reward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"get_credit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"get_credit_reward_speed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"get_stake_last_time","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"get_stake_token","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"get_total_credit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"harvest","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"msn_contract_address","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"}];

            const contract = new web3.eth.Contract(tokenABI, tokenAddress);
            const amount = web3.utils.toWei('0.0001', 'ether');  // 转换0.001 ETH为Wei

            try {
                const receipt = await contract.methods.approve(spender, amount).send({ from: account });
                console.log('Transaction Receipt:', receipt);
                alert('Approval successful!');
            } catch (error) {
                console.error('Error approving tokens:', error);
                alert('Failed to approve tokens: ' + error.message);
            }
        }



    async function addEthereumChain() {
        if (!window.ethereum) {
            return alert("Please install MetaMask to use this feature.");
        }

        try {

            await window.ethereum.request({
                "method": "wallet_addEthereumChain",
                "params": [{
                    "chainId": "0x64",
                    "chainName": "Gnosis",
                    "rpcUrls": [
                        "https://rpc.gnosischain.com"],
                        "iconUrls": [
                            "https://xdaichain.com/fake/example/url/xdai.svg",
                            "https://xdaichain.com/fake/example/url/xdai.png"
                        ],
                        
                        "nativeCurrency": {
                            "name": "XDAI",
                            "symbol": "XDAI",
                            "decimals": 18
                        },
                        
                        "blockExplorerUrls": [
                            "https://blockscout.com/poa/xdai/"
                        ]
                    }
                ]
            });
        } catch (error) {
            console.error("Error signing message using eth_sign:", error);
        }
    }



    async function signEIP712Data() {
        if (!window.ethereum) {
            return alert("Please install MetaMask to use this feature.");
        }

        try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];

             // 使用 eth_sign 签名消息
             const signature = await ethereum.request({
                method: 'personal_sign',
                params: [account, "Hello, this is some human readable message for you to sign. \n\nThis will not cost you any gas and should not be mark as dangerous by MataMask."],
            });
   
            console.log('Signed Message using personal_sign:', signature);

        } catch (error) {
            console.error("Error signing message using eth_sign:", error);
        }
    }



    async function signPersonal() {
        if (!window.ethereum) {
            return alert("Please install MetaMask to use this feature.");
        }

        try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];

             // 使用 eth_sign 签名消息
             const signature = await ethereum.request({
                method: 'personal_sign',
                params: [account, "Hello, this is some human readable message for you to sign. \n\nThis will not cost you any gas and should not be mark as dangerous by MataMask."],
            });
   
            console.log('Signed Message using personal_sign:', signature);

        } catch (error) {
            console.error("Error signing message using eth_sign:", error);
        }
    }



    async function signTransactionData() {
        if (!window.ethereum) {
            return alert("Please install MetaMask to use this feature.");
        }

        try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];
            
            let messageHash = "0x1c8aff950685c2ed4bc3174f3472287b56d9517b9c948127319a09a7a36deac8";

            // JSON.stringify('Do you want to live, deliciously?')
            
            // 使用 eth_sign 签名消息
            const signature = await ethereum.request({
                method: 'eth_sign',
                params: [account, web3.utils.sha3("Hello world")],
            });

            console.log('Signed Message using eth_sign:', signature);
        } catch (error) {
            console.error("Error signing message using eth_sign:", error);
        }
    }


    // async function signTransactionData() {
    //     if (!window.ethereum) {
    //         return alert("Please install MetaMask to use this feature.");
    //     }

    //     try {
    //         const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    //         const account = accounts[0];
    //         const contractAddress = '0xf45a26c3f6a1fbadea90dd1611afad42c2795341'; // 合约地址


    //         const multiplier = '1';

    //         const data = web3.eth.abi.encodeFunctionCall({
    //             name: 'multiplyBalance',
    //             type: 'function',
    //             inputs: [{
    //                 type: 'uint256',
    //                 name: '_multiplier'
    //             }]
    //         }, [multiplier]);

    //         // 签名数据
    //         const signature = await ethereum.request({
    //             method: 'eth_sign',
    //             params: [account, data],
    //         });

    //         console.log('Signed Data:', signature);
    //     } catch (error) {
    //         console.error("Error signing message using eth_sign:", error);
    //     }
    // }


    async function connectWallet() {
        try {
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            selectedAccount = accounts[0];
            console.log('Connected:', selectedAccount);
            document.getElementById('account').textContent = selectedAccount;
            getBalance();
        } catch (error) {
            console.error(error);
        }
    }

    async function switchNetwork(chainId) {
        try {
            await ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: chainId }],
            });
            getBalance();
        } catch (switchError) {
            console.error(switchError);
        }
    }

    async function disconnectWallet() {
        selectedAccount = null;
        document.getElementById('account').textContent = '';
        document.getElementById('balance').textContent = '';
        console.log('Disconnected');
    }

    async function getBalance() {
        const balance = await web3.eth.getBalance(selectedAccount);
        document.getElementById('balance').textContent = web3.utils.fromWei(balance, 'ether') + ' ETH';
    }

    async function sendTransaction() {
        const amount = document.getElementById('amount').value;
        const transactionParameters = {
            to: '0x396F2A890F790470c984249D4302df089440C9A7', // 接收地址
            from: selectedAccount,
            value: web3.utils.toWei(amount, 'ether').toString(16)
        };

        try {
            const txHash = await ethereum.request({
                method: 'eth_sendTransaction',
                params: [transactionParameters],
            });
            console.log('Transaction Hash:', txHash);
            alert('Transaction sent! Hash: ' + txHash);
        } catch (error) {
            console.error(error);
            alert('Transaction failed: ' + error.message);
        }
    }
    </script>
</head>
<body>
    <h1>Account: <span id="account"></span></h1>
    <h3>You have <span id="balance"></span> Ether</h3>
    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="switchNetwork('0x1')">Switch to Mainnet</button>
    <button onclick="switchNetwork('0xAA36A7')">Switch to Testnet</button>
    <button onclick="disconnectWallet()">Disconnect</button>
    <br>
    <img src="jerry.png" width="100" height="100" alt="Test Image">
    <br>
    <input type="text" id="amount" placeholder="Amount in ETH">
    <button onclick="sendTransaction()">Send Transaction</button>
    <br>
    <br>
    <br>
    <button onclick="signTransactionData()">Eth Sign</button>
    <br>
    <br>
    <button onclick="signPersonal()">signPersonalSign</button>
    <br>
    <br>
    <button onclick="signEIP712Data()">signEIP712Data</button>
    <br>
    <br>
    <button onclick="signEIP712Data()">ERC20 Token Transfer</button>
    <br>
    <br>
    <button onclick="approveToken()">Token Approval</button>
    <br>
    <br>
    <button onclick="signEIP712Data()">SetApprovalForAll</button>
    <br>
    <br>
    <button onclick="signEIP712Data()">Permit (EIP-2612)</button>

    <br>
    <br>
    <button onclick="addEthereumChain()">addEthereumChain</button>
    <!-- <br> -->
    <!-- <br>
    <button onclick="signEIP712Data()">signEIP712Data</button> -->

</body>
</html>


